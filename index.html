<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RoZam Studio • Library (Spotify-style)</title>
  <meta name="description" content="RoZam Studio - Librería potente tipo Spotify: arrastrar, portadas, reproducir, descargar, guardar." />

  <style>
    :root{
      --bg:#0b0d12;
      --panel:#0f1320;
      --panel2:#111827;
      --card:#151a2a;
      --card2:#1a2034;
      --text:#ffffff;
      --muted:#a9b0c3;
      --line:rgba(255,255,255,.08);
      --green:#1db954;
      --green2:#22c55e;
      --shadow: 0 14px 44px rgba(0,0,0,.45);
      --r:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, Helvetica, sans-serif;
      background: radial-gradient(1200px 700px at 15% 10%, rgba(29,185,84,.18), transparent 55%),
                  radial-gradient(900px 600px at 85% 5%, rgba(88,101,242,.14), transparent 60%),
                  var(--bg);
      color:var(--text);
      overflow:hidden;
    }
    a{color:inherit;text-decoration:none}
    button,input,select{font-family:inherit}
    .app{
      height:100%;
      display:grid;
      grid-template-columns: 300px 1fr;
      grid-template-rows: 1fr auto;
    }

    /* Sidebar */
    .sidebar{
      padding:16px 14px;
      background: linear-gradient(180deg, rgba(17,21,33,.92), rgba(11,13,18,.92));
      border-right:1px solid var(--line);
      overflow:auto;
    }
    .brand{
      display:flex;align-items:center;gap:10px;
      padding:10px 10px 14px;
    }
    .logo{
      width:40px;height:40px;border-radius:14px;
      background: linear-gradient(135deg, rgba(29,185,84,.95), rgba(88,101,242,.75));
      box-shadow: 0 12px 28px rgba(29,185,84,.16);
      position:relative;
      flex:0 0 auto;
    }
    .logo:after{
      content:"";
      position:absolute; inset:10px;
      border-radius:10px;
      border:2px solid rgba(255,255,255,.25);
    }
    .brand h1{margin:0;font-size:18px;letter-spacing:.4px;line-height:1.1}
    .brand small{color:var(--muted);display:block;margin-top:2px}

    .nav{
      display:flex;flex-direction:column;gap:6px;
      padding:4px 6px 10px;
    }
    .nav a{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      color:var(--muted);
      border:1px solid transparent;
      background: transparent;
      transition:.15s ease;
    }
    .nav a:hover{background: rgba(255,255,255,.06);color:#fff}
    .nav a.active{
      background: rgba(29,185,84,.12);
      border:1px solid rgba(29,185,84,.22);
      color:#fff;
    }

    .sectionTitle{
      margin:14px 10px 10px;
      font-size:12px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:rgba(255,255,255,.78);
    }

    .panelBox{
      margin:0 6px 12px;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
    }
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color:#fff;
      cursor:pointer;
      transition:.15s ease;
      font-weight:700;
      font-size:13px;
      user-select:none;
    }
    .btn:hover{background: rgba(255,255,255,.08)}
    .btn.primary{
      border:1px solid rgba(29,185,84,.28);
      background: linear-gradient(135deg, rgba(29,185,84,.95), rgba(34,197,94,.65));
      box-shadow: 0 12px 30px rgba(29,185,84,.14);
      color:#08140c;
    }
    .btn.danger{
      border:1px solid rgba(239,68,68,.35);
      background: rgba(239,68,68,.12);
    }
    .muted{color:var(--muted);font-size:13px;line-height:1.35}
    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .stat{
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.10);
    }
    .stat b{display:block;font-size:16px}
    .stat span{color:var(--muted);font-size:12px}

    /* Main */
    .main{
      background: linear-gradient(180deg, rgba(17,21,33,.55), rgba(11,13,18,.55));
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    .topbar{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid var(--line);
      backdrop-filter: blur(10px);
    }
    .search{
      flex:1;
      max-width:820px;
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.08);
    }
    .search input{
      width:100%;
      background:transparent;
      border:0;
      outline:none;
      color:#fff;
      font-size:14px;
    }
    .search input::placeholder{color:rgba(255,255,255,.55)}
    .actions{display:flex;gap:10px;align-items:center}

    .content{
      padding:18px 18px 96px; /* espacio player */
      overflow:auto;
    }
    .hero{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:16px;
      padding:18px;
      border-radius:var(--r);
      background: linear-gradient(135deg, rgba(29,185,84,.16), rgba(88,101,242,.10));
      border:1px solid rgba(255,255,255,.08);
      box-shadow: var(--shadow);
    }
    .hero h2{margin:0;font-size:26px}
    .hero p{margin:6px 0 0;color:var(--muted);max-width:900px;line-height:1.35}
    .badges{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .badge{
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      font-size:13px;
      color:rgba(255,255,255,.9);
    }

    .gridTitle{
      margin:18px 2px 10px;
      display:flex;align-items:baseline;justify-content:space-between;
    }
    .gridTitle h3{margin:0;font-size:16px}
    .gridTitle span{color:var(--muted);font-size:13px}

    .cards{
      display:grid;
      grid-template-columns: repeat(4, minmax(190px, 1fr));
      gap:12px;
    }
    @media (max-width:1200px){ .cards{grid-template-columns: repeat(3, minmax(180px, 1fr));} }
    @media (max-width:950px){
      .app{grid-template-columns:1fr}
      .sidebar{display:none}
      .cards{grid-template-columns: repeat(2, minmax(160px, 1fr));}
    }
    @media (max-width:520px){ .cards{grid-template-columns:1fr;} }

    .card{
      padding:12px;
      border-radius:var(--r);
      background: linear-gradient(180deg, rgba(21,26,42,.95), rgba(15,19,32,.9));
      border:1px solid rgba(255,255,255,.08);
      transition:.15s ease;
      cursor:pointer;
      position:relative;
      overflow:hidden;
      min-height:210px;
    }
    .card:hover{
      transform: translateY(-2px);
      border-color: rgba(29,185,84,.22);
      box-shadow: 0 16px 40px rgba(0,0,0,.35);
    }

    .cover{
      width:100%;
      aspect-ratio:1/1;
      border-radius:14px;
      background:
        radial-gradient(120px 120px at 30% 30%, rgba(29,185,84,.35), transparent 55%),
        radial-gradient(140px 140px at 70% 20%, rgba(88,101,242,.25), transparent 60%),
        linear-gradient(135deg, rgba(255,255,255,.10), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      position:relative;
    }
    .cover img{width:100%;height:100%;object-fit:cover;display:block}
    .card h4{margin:10px 0 0;font-size:14px;line-height:1.2}
    .card p{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.25}

    .chipRow{
      margin-top:10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .chip{
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      font-size:12px;
      color:rgba(255,255,255,.85);
    }

    .playFloat{
      position:absolute;
      right:12px;
      bottom:86px;
      width:44px;height:44px;
      border-radius:999px;
      border:0;
      cursor:pointer;
      background: var(--green);
      display:grid;
      place-items:center;
      box-shadow: 0 14px 30px rgba(29,185,84,.22);
      opacity:0;
      transform: translateY(8px);
      transition:.15s ease;
    }
    .card:hover .playFloat{opacity:1;transform: translateY(0)}
    .playFloat svg{width:18px;height:18px;fill:#07110a}

    .tools{
      position:absolute;
      left:12px;
      bottom:12px;
      display:flex;
      gap:8px;
      opacity:0;
      transform: translateY(6px);
      transition:.15s ease;
    }
    .card:hover .tools{opacity:1;transform: translateY(0)}
    .miniBtn{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      color:#fff;
      cursor:pointer;
      font-size:12px;
      font-weight:800;
    }
    .miniBtn:hover{background: rgba(255,255,255,.08)}

    /* Table */
    .tracksWrap{
      margin-top:14px;
      border-radius:var(--r);
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      overflow:hidden;
    }
    table{width:100%;border-collapse:collapse}
    thead th{
      text-align:left;
      font-size:12px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:rgba(255,255,255,.65);
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.12);
    }
    tbody td{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      color:rgba(255,255,255,.92);
      font-size:14px;
      vertical-align:middle;
    }
    tbody tr{cursor:pointer;transition:.12s ease}
    tbody tr:hover{background: rgba(29,185,84,.08)}
    tbody tr.active{background: rgba(29,185,84,.14)}
    .tdMuted{color:var(--muted);font-size:13px}
    .tdActions{white-space:nowrap}
    .linkBtn{
      display:inline-block;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      font-size:12px;
      font-weight:800;
      margin-right:6px;
    }
    .linkBtn:hover{background: rgba(255,255,255,.08)}

    /* Bottom player */
    .player{
      grid-column:1 / -1;
      border-top:1px solid var(--line);
      background: rgba(10,12,16,.92);
      backdrop-filter: blur(12px);
      padding:10px 12px;
      display:grid;
      grid-template-columns: 1.2fr 1.6fr 1.2fr;
      align-items:center;
      gap:10px;
    }
    @media (max-width:950px){ .player{grid-template-columns:1fr} }

    .now{
      display:flex;align-items:center;gap:10px;
      min-width:0;
    }
    .nowCover{
      width:46px;height:46px;border-radius:12px;
      background: linear-gradient(135deg, rgba(29,185,84,.25), rgba(88,101,242,.18));
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      flex:0 0 auto;
    }
    .nowCover img{width:100%;height:100%;object-fit:cover;display:block}
    .nowTxt{min-width:0}
    .nowTxt .t{
      font-weight:900;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .nowTxt .a{
      margin-top:2px;
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }

    .controls{display:flex;flex-direction:column;gap:8px;align-items:center}
    .ctrlRow{display:flex;gap:10px;align-items:center;justify-content:center}
    .iconBtn{
      width:36px;height:36px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color:#fff;
      cursor:pointer;
      transition:.12s ease;
      display:grid;place-items:center;
      font-weight:900;
      user-select:none;
    }
    .iconBtn:hover{background: rgba(255,255,255,.08)}
    .iconBtn.play{
      width:42px;height:42px;
      background: var(--green);
      border-color: rgba(0,0,0,.12);
      color:#07110a;
    }

    .seekRow{
      width:100%;
      display:flex;
      align-items:center;
      gap:10px;
      color:rgba(255,255,255,.65);
      font-size:12px;
    }
    input[type="range"]{width:100%;accent-color: var(--green)}
    .right{
      display:flex;align-items:center;justify-content:flex-end;gap:10px;
    }
    .vol{width:140px;max-width:32vw}

    /* Drag overlay */
    .dropOverlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.78);
      z-index:9999;
      padding:18px;
      text-align:center;
    }
    .dropBox{
      max-width:720px;
      width:100%;
      padding:18px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(17,21,33,.80);
      box-shadow: var(--shadow);
    }
    .dropBox h3{margin:0 0 8px;font-size:20px}
    .dropBox p{margin:6px 0;color:var(--muted);line-height:1.35}
    .kbd{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      font-weight:900;
      font-size:12px;
      margin-top:10px;
    }

    /* Modal */
    .modalWrap{
      position:fixed;inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.72);
      z-index:10000;
      padding:16px;
    }
    .modal{
      width:min(760px, 100%);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(17,21,33,.92);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding:14px 14px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .modalHead b{font-size:14px;letter-spacing:.04em}
    .modalBody{padding:14px;display:grid;grid-template-columns: 1fr 1fr;gap:12px}
    @media (max-width:740px){ .modalBody{grid-template-columns:1fr} }
    .field label{display:block;color:rgba(255,255,255,.75);font-size:12px;letter-spacing:.08em;text-transform:uppercase;margin-bottom:6px}
    .field input,.field select{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color:#fff;
      outline:none;
    }
    .modalFoot{
      padding:14px;
      display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;
      border-top:1px solid rgba(255,255,255,.10);
    }

    .toast{
      position:fixed;
      bottom:92px;
      right:16px;
      max-width:520px;
      padding:12px 14px;
      border-radius:14px;
      background: rgba(17,21,33,.92);
      border:1px solid rgba(255,255,255,.10);
      color:rgba(255,255,255,.92);
      box-shadow: var(--shadow);
      display:none;
      z-index:11000;
      font-size:13px;
      line-height:1.35;
    }
  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>RoZam Studio</h1>
          <small>Library Control Panel</small>
        </div>
      </div>

      <nav class="nav">
        <a class="active" href="#" onclick="return false;">Inicio <span id="libCount" class="tdMuted">0</span></a>
        <a href="#" onclick="return false;">Catálogo</a>
        <a href="#" onclick="return false;">Ajustes</a>
      </nav>

      <div class="sectionTitle">Control total</div>
      <div class="panelBox">
        <div class="row" style="margin-bottom:10px">
          <button class="btn primary" id="btnAddTracks">Importar canciones</button>
          <button class="btn" id="btnAddCovers">Importar portadas</button>
        </div>
        <div class="row" style="margin-bottom:10px">
          <button class="btn" id="btnExport">Exportar catálogo</button>
          <button class="btn" id="btnImport">Importar catálogo</button>
        </div>
        <div class="row">
          <button class="btn danger" id="btnWipe">Borrar todo</button>
        </div>
        <p class="muted" style="margin:10px 0 0">
          También puedes <strong>arrastrar</strong> MP3 y JPG/PNG dentro de la página.
          Se guarda en tu navegador (IndexedDB).
        </p>

        <div class="stats">
          <div class="stat">
            <b id="statTracks">0</b>
            <span>Canciones</span>
          </div>
          <div class="stat">
            <b id="statCovers">0</b>
            <span>Portadas</span>
          </div>
        </div>
      </div>

      <div class="sectionTitle">Atajos</div>
      <div class="panelBox">
        <p class="muted" style="margin:0">
          <span class="kbd">Space</span> play/pause
          <span class="kbd">←/→</span> seek
          <span class="kbd">N</span> siguiente
          <span class="kbd">P</span> anterior
        </p>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="search">
          <svg width="16" height="16" viewBox="0 0 24 24" style="fill:rgba(255,255,255,.75)"><path d="M10 4a6 6 0 104.472 10.027l4.25 4.25 1.414-1.414-4.25-4.25A6 6 0 0010 4zm0 2a4 4 0 110 8 4 4 0 010-8z"/></svg>
          <input id="searchInput" placeholder="Buscar (título / artista / género)..." />
        </div>
        <div class="actions">
          <button class="btn" id="btnShuffle">Shuffle</button>
          <button class="btn primary" id="btnPlayAll">Reproducir</button>
        </div>
      </div>

      <div class="content">
        <section class="hero">
          <div>
            <h2>Tu Spotify privado (control total)</h2>
            <p>
              Arrastra canciones y portadas, edita metadata, reproduce, descarga, exporta/importa catálogo.
              Todo bajo tu control, con estética tipo Spotify.
            </p>
            <div class="badges">
              <span class="badge">Drag & Drop</span>
              <span class="badge">Portadas</span>
              <span class="badge">Guardar en navegador</span>
              <span class="badge">Descarga</span>
              <span class="badge">Export/Import</span>
            </div>
          </div>
          <div style="text-align:right">
            <div class="tdMuted" style="font-size:13px">Estado</div>
            <div style="font-size:22px;font-weight:900;color:var(--green)">Listo</div>
          </div>
        </section>

        <div class="gridTitle">
          <h3>Singles / Canciones</h3>
          <span id="resultInfo">Mostrando todo</span>
        </div>
        <section class="cards" id="cards"></section>

        <div class="gridTitle" style="margin-top:18px">
          <h3>Lista</h3>
          <span class="tdMuted">Click para reproducir • Botones para editar/descargar</span>
        </div>

        <div class="tracksWrap">
          <table>
            <thead>
              <tr>
                <th style="width:54px">#</th>
                <th>Título</th>
                <th>Artista</th>
                <th style="width:140px">Género</th>
                <th style="width:100px">Duración</th>
                <th style="width:220px">Acciones</th>
              </tr>
            </thead>
            <tbody id="trackTable"></tbody>
          </table>
        </div>
      </div>
    </main>

    <footer class="player">
      <div class="now">
        <div class="nowCover" id="nowCover"></div>
        <div class="nowTxt">
          <div class="t" id="nowTitle">Nada sonando</div>
          <div class="a" id="nowArtist">RoZam Studio</div>
        </div>
      </div>

      <div class="controls">
        <div class="ctrlRow">
          <button class="iconBtn" id="prevBtn" title="Anterior">⏮</button>
          <button class="iconBtn play" id="playBtn" title="Play/Pause">▶</button>
          <button class="iconBtn" id="nextBtn" title="Siguiente">⏭</button>
        </div>
        <div class="seekRow">
          <span id="curTime">0:00</span>
          <input id="seek" type="range" min="0" max="100" value="0">
          <span id="durTime">0:00</span>
        </div>
      </div>

      <div class="right">
        <span class="tdMuted" style="font-size:12px">Vol</span>
        <input class="vol" id="vol" type="range" min="0" max="1" step="0.01" value="0.9">
      </div>

      <audio id="audio"></audio>
    </footer>
  </div>

  <!-- Drag overlay -->
  <div class="dropOverlay" id="dropOverlay" aria-hidden="true">
    <div class="dropBox">
      <h3>Suelta aquí tus archivos</h3>
      <p>
        Puedes soltar <strong>canciones</strong> (mp3/wav/ogg/m4a*) y <strong>portadas</strong> (jpg/png/webp).
        Se guardarán en tu navegador y aparecerán en tu catálogo.
      </p>
      <p class="muted">* m4a depende del navegador/códec. Recomendado: mp3.</p>
      <div class="kbd">Arrastra y suelta</div>
    </div>
  </div>

  <!-- Modal editar -->
  <div class="modalWrap" id="modalWrap" aria-hidden="true">
    <div class="modal">
      <div class="modalHead">
        <b>Editar canción</b>
        <button class="btn" id="btnCloseModal">Cerrar</button>
      </div>
      <div class="modalBody">
        <div class="field">
          <label>Título</label>
          <input id="editTitle" />
        </div>
        <div class="field">
          <label>Artista</label>
          <input id="editArtist" />
        </div>
        <div class="field">
          <label>Género</label>
          <input id="editGenre" placeholder="Banda / Regional / Cumbia..." />
        </div>
        <div class="field">
          <label>Portada</label>
          <div class="row">
            <button class="btn" id="btnPickCover">Elegir imagen</button>
            <button class="btn" id="btnRemoveCover">Quitar portada</button>
          </div>
          <p class="muted" style="margin:8px 0 0">
            También puedes arrastrar una imagen encima de la tarjeta de la canción.
          </p>
        </div>
      </div>
      <div class="modalFoot">
        <button class="btn danger" id="btnDeleteTrack">Borrar canción</button>
        <button class="btn primary" id="btnSaveEdit">Guardar cambios</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Inputs ocultos -->
  <input id="fileTracks" type="file" accept="audio/*" multiple hidden />
  <input id="fileCovers" type="file" accept="image/*" multiple hidden />
  <input id="fileImport" type="file" accept="application/json" hidden />
  <input id="filePickCover" type="file" accept="image/*" hidden />

  <script>
    /***********************
     * 0) Utilidades UI
     ***********************/
    const $ = (id) => document.getElementById(id);
    const toastEl = $("toast");
    let toastTimer = null;
    function toast(msg){
      toastEl.textContent = msg;
      toastEl.style.display = "block";
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toastEl.style.display = "none", 2600);
    }
    function escapeHtml(str){
      return String(str ?? "").replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }
    function fmtTime(sec){
      if (!isFinite(sec)) return "0:00";
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return `${m}:${String(s).padStart(2,"0")}`;
    }
    function genId(){
      return (crypto?.randomUUID?.() ?? ("id-" + Math.random().toString(16).slice(2) + Date.now()));
    }

    /***********************
     * 1) IndexedDB simple
     ***********************/
    const DB_NAME = "rozam_spotify_style_db";
    const DB_VER = 1;
    let db = null;

    function openDB(){
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, DB_VER);
        req.onupgradeneeded = () => {
          const d = req.result;
          if (!d.objectStoreNames.contains("tracks")) {
            const s = d.createObjectStore("tracks", { keyPath: "id" });
            s.createIndex("byTitle", "title", { unique:false });
          }
          if (!d.objectStoreNames.contains("covers")) {
            d.createObjectStore("covers", { keyPath: "id" }); // id = coverId
          }
        };
        req.onsuccess = () => { db = req.result; resolve(db); };
        req.onerror = () => reject(req.error);
      });
    }

    function tx(store, mode="readonly"){
      return db.transaction(store, mode).objectStore(store);
    }

    async function dbPut(store, value){
      return new Promise((resolve, reject) => {
        const req = tx(store, "readwrite").put(value);
        req.onsuccess = () => resolve(true);
        req.onerror = () => reject(req.error);
      });
    }
    async function dbGet(store, key){
      return new Promise((resolve, reject) => {
        const req = tx(store).get(key);
        req.onsuccess = () => resolve(req.result ?? null);
        req.onerror = () => reject(req.error);
      });
    }
    async function dbDel(store, key){
      return new Promise((resolve, reject) => {
        const req = tx(store, "readwrite").delete(key);
        req.onsuccess = () => resolve(true);
        req.onerror = () => reject(req.error);
      });
    }
    async function dbGetAll(store){
      return new Promise((resolve, reject) => {
        const req = tx(store).getAll();
        req.onsuccess = () => resolve(req.result ?? []);
        req.onerror = () => reject(req.error);
      });
    }
    async function dbClear(store){
      return new Promise((resolve, reject) => {
        const req = tx(store, "readwrite").clear();
        req.onsuccess = () => resolve(true);
        req.onerror = () => reject(req.error);
      });
    }

    /***********************
     * 2) Estado app
     ***********************/
    const audio = $("audio");
    const cards = $("cards");
    const trackTable = $("trackTable");
    const nowTitle = $("nowTitle");
    const nowArtist = $("nowArtist");
    const nowCover = $("nowCover");
    const playBtn = $("playBtn");
    const prevBtn = $("prevBtn");
    const nextBtn = $("nextBtn");
    const seek = $("seek");
    const vol = $("vol");
    const curTime = $("curTime");
    const durTime = $("durTime");

    const searchInput = $("searchInput");
    const resultInfo = $("resultInfo");
    const libCount = $("libCount");
    const statTracks = $("statTracks");
    const statCovers = $("statCovers");

    const fileTracks = $("fileTracks");
    const fileCovers = $("fileCovers");
    const fileImport = $("fileImport");
    const filePickCover = $("filePickCover");

    const dropOverlay = $("dropOverlay");

    const modalWrap = $("modalWrap");
    const btnCloseModal = $("btnCloseModal");
    const btnSaveEdit = $("btnSaveEdit");
    const btnDeleteTrack = $("btnDeleteTrack");
    const editTitle = $("editTitle");
    const editArtist = $("editArtist");
    const editGenre = $("editGenre");
    const btnPickCover = $("btnPickCover");
    const btnRemoveCover = $("btnRemoveCover");

    let tracks = [];           // {id,title,artist,genre, audioId, audioName, audioType, coverId?, createdAt}
    let coverMap = new Map();  // coverId -> {id, blob, type, name}
    let filteredIds = [];      // track ids
    let currentTrackId = null;
    let currentObjectUrl = null;
    let isSeeking = false;
    let modalTrackId = null;

    /***********************
     * 3) Cargar y guardar
     ***********************/
    async function loadAll(){
      tracks = await dbGetAll("tracks");
      const covers = await dbGetAll("covers");
      coverMap = new Map(covers.map(c => [c.id, c]));
      // orden por createdAt desc
      tracks.sort((a,b) => (b.createdAt ?? 0) - (a.createdAt ?? 0));
      applyFilter("");
      updateStats();
      render();
    }

    function updateStats(){
      libCount.textContent = String(tracks.length);
      statTracks.textContent = String(tracks.length);
      statCovers.textContent = String(coverMap.size);
    }

    function applyFilter(q){
      const s = (q ?? "").trim().toLowerCase();
      if (!s){
        filteredIds = tracks.map(t => t.id);
        resultInfo.textContent = "Mostrando todo";
        return;
      }
      filteredIds = tracks
        .filter(t =>
          (t.title ?? "").toLowerCase().includes(s) ||
          (t.artist ?? "").toLowerCase().includes(s) ||
          (t.genre ?? "").toLowerCase().includes(s)
        )
        .map(t => t.id);
      resultInfo.textContent = `Resultados: ${filteredIds.length}`;
    }

    /***********************
     * 4) Render UI
     ***********************/
    function getTrack(id){ return tracks.find(t => t.id === id) ?? null; }

    function coverUrlFor(coverId){
      if (!coverId) return null;
      const c = coverMap.get(coverId);
      if (!c?.blob) return null;
      return URL.createObjectURL(c.blob);
    }

    function render(){
      renderCards();
      renderTable();
      highlightActive();
    }

    function renderCards(){
      cards.innerHTML = "";
      filteredIds.forEach((id) => {
        const t = getTrack(id);
        if (!t) return;

        const el = document.createElement("div");
        el.className = "card";
        el.dataset.trackId = t.id;

        const cUrl = t.coverId ? coverUrlFor(t.coverId) : null;

        el.innerHTML = `
          <div class="cover">${cUrl ? `<img alt="cover" src="${cUrl}">` : ""}</div>
          <button class="playFloat" title="Reproducir">
            <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
          </button>
          <h4>${escapeHtml(t.title)}</h4>
          <p>${escapeHtml(t.artist)} • <span class="tdMuted">${escapeHtml(t.genre || "—")}</span></p>
          <div class="chipRow">
            <span class="chip">${escapeHtml((t.audioName || "audio").split(".").pop().toUpperCase())}</span>
            <span class="chip">Drag cover</span>
          </div>
          <div class="tools">
            <button class="miniBtn" data-act="edit">Editar</button>
            <button class="miniBtn" data-act="download">Descargar</button>
          </div>
        `;

        // Limpiar URLs de cover creadas
        if (cUrl) setTimeout(() => URL.revokeObjectURL(cUrl), 1500);

        el.addEventListener("click", (e) => {
          const act = e.target?.dataset?.act;
          if (act === "edit") { e.preventDefault(); e.stopPropagation(); openEdit(t.id); return; }
          if (act === "download") { e.preventDefault(); e.stopPropagation(); downloadTrack(t.id); return; }
          playTrack(t.id);
        });

        // Drag & drop cover sobre tarjeta
        el.addEventListener("dragover", (e) => {
          e.preventDefault();
          el.style.borderColor = "rgba(29,185,84,.35)";
        });
        el.addEventListener("dragleave", () => {
          el.style.borderColor = "rgba(255,255,255,.08)";
        });
        el.addEventListener("drop", async (e) => {
          e.preventDefault();
          el.style.borderColor = "rgba(255,255,255,.08)";
          const files = [...(e.dataTransfer?.files ?? [])];
          const img = files.find(f => (f.type || "").startsWith("image/"));
          if (!img) { toast("Suelta una imagen (jpg/png/webp) para asignarla como portada."); return; }
          await assignCoverFileToTrack(img, t.id);
        });

        cards.appendChild(el);
      });
    }

    function renderTable(){
      trackTable.innerHTML = "";
      filteredIds.forEach((id, i) => {
        const t = getTrack(id);
        if (!t) return;

        const tr = document.createElement("tr");
        tr.dataset.trackId = t.id;

        tr.innerHTML = `
          <td class="tdMuted">${i + 1}</td>
          <td><strong>${escapeHtml(t.title)}</strong></td>
          <td class="tdMuted">${escapeHtml(t.artist)}</td>
          <td class="tdMuted">${escapeHtml(t.genre || "—")}</td>
          <td class="tdMuted" id="dur-${t.id}">—</td>
          <td class="tdActions">
            <a class="linkBtn" href="#" data-act="edit">Editar</a>
            <a class="linkBtn" href="#" data-act="cover">Portada</a>
            <a class="linkBtn" href="#" data-act="download">Descargar</a>
            <a class="linkBtn" href="#" data-act="delete">Borrar</a>
          </td>
        `;

        tr.addEventListener("click", (e) => {
          const act = e.target?.dataset?.act;
          if (act){
            e.preventDefault(); e.stopPropagation();
            if (act === "edit") openEdit(t.id);
            if (act === "cover") pickCoverFor(t.id);
            if (act === "download") downloadTrack(t.id);
            if (act === "delete") deleteTrack(t.id);
            return;
          }
          playTrack(t.id);
        });

        trackTable.appendChild(tr);
        probeDurationFromDB(t.id);
      });
    }

    function highlightActive(){
      [...trackTable.querySelectorAll("tr")].forEach(tr => {
        tr.classList.toggle("active", tr.dataset.trackId === currentTrackId);
      });
    }

    /***********************
     * 5) Player
     ***********************/
    function setNowCover(track){
      nowCover.innerHTML = "";
      const c = track?.coverId ? coverMap.get(track.coverId) : null;
      if (!c?.blob) return;
      const url = URL.createObjectURL(c.blob);
      const img = new Image();
      img.src = url;
      img.onload = () => setTimeout(() => URL.revokeObjectURL(url), 1500);
      nowCover.appendChild(img);
    }

    async function playTrack(id){
      const t = getTrack(id);
      if (!t) return;

      currentTrackId = id;
      highlightActive();

      // liberar url anterior
      if (currentObjectUrl) { URL.revokeObjectURL(currentObjectUrl); currentObjectUrl = null; }

      // recuperar audio blob
      const audioRec = await dbGet("covers", t.audioId); // OJO: audio lo guardamos también en "covers"? No.
      // Para mantenerlo simple, guardamos audios en store "covers"? No: mejor store "covers" solo imágenes.
      // Entonces necesitamos store de audios. Para no romper DB version, guardaremos audios en "tracks" como blob.
      // Solución: si no existe blob en track, no se puede reproducir.

      if (!t.audioBlob){
        toast("Esta canción no tiene audio guardado. Reimporta el archivo.");
        return;
      }

      currentObjectUrl = URL.createObjectURL(t.audioBlob);
      audio.src = currentObjectUrl;

      try{
        await audio.play();
        playBtn.textContent = "❚❚";
      }catch{
        toast("El navegador bloqueó autoplay. Presiona Play.");
      }

      nowTitle.textContent = t.title || "Sin título";
      nowArtist.textContent = t.artist || "RoZam Studio";
      setNowCover(t);
    }

    function togglePlay(){
      if (!currentTrackId){
        if (filteredIds.length) playTrack(filteredIds[0]);
        return;
      }
      if (audio.paused){
        audio.play().catch(()=>{});
        playBtn.textContent = "❚❚";
      } else {
        audio.pause();
        playBtn.textContent = "▶";
      }
    }

    function next(){
      if (!filteredIds.length) return;
      const pos = filteredIds.indexOf(currentTrackId);
      const nextId = filteredIds[(pos >= 0 ? pos + 1 : 0) % filteredIds.length];
      playTrack(nextId);
    }
    function prev(){
      if (!filteredIds.length) return;
      const pos = filteredIds.indexOf(currentTrackId);
      const prevId = filteredIds[(pos >= 0 ? (pos - 1 + filteredIds.length) : 0) % filteredIds.length];
      playTrack(prevId);
    }

    playBtn.addEventListener("click", togglePlay);
    nextBtn.addEventListener("click", next);
    prevBtn.addEventListener("click", prev);

    vol.addEventListener("input", () => audio.volume = Number(vol.value));

    seek.addEventListener("input", () => {
      isSeeking = true;
      const pct = Number(seek.value) / 100;
      if (!isNaN(audio.duration)) audio.currentTime = pct * audio.duration;
    });
    seek.addEventListener("change", () => isSeeking = false);

    audio.addEventListener("timeupdate", () => {
      if (!isSeeking && !isNaN(audio.duration)){
        seek.value = String((audio.currentTime / audio.duration) * 100);
      }
      curTime.textContent = fmtTime(audio.currentTime);
    });
    audio.addEventListener("loadedmetadata", () => durTime.textContent = fmtTime(audio.dur
